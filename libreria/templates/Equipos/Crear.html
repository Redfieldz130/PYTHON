{% extends "Paginas/Base.html" %}

{% block titulo %}Agregar Equipo{% endblock %}

{% block contenido %}
<div class="container">
    <div class="card shadow p-4" style="max-width: 100%; width: 100%; max-width: 900px; margin: 0 auto;">
        <div class="card-header text-center">
            <h4>Agregar nuevo equipo</h4>
        </div>
        <div class="card-body">
            {% if messages %}
                <div class="alert alert-info">
                    {% for message in messages %}
                        <p>{{ message }}</p>
                    {% endfor %}
                </div>
            {% endif %}

            {% if formulario.errors %}
                <div class="alert alert-danger">
                    <p><strong>Error:</strong> Por favor corrige los siguientes errores:</p>
                    <ul>
                        {% for field, errors in formulario.errors.items %}
                            <li>{{ field }}: {{ errors|striptags }}</li>
                        {% endfor %}
                    </ul>
                </div>
            {% endif %}

            <form method="post" enctype="multipart/form-data" id="equipoForm" class="needs-validation" novalidate>
                {% csrf_token %}
                <div class="row">
                    <div class="col-12 col-md-6 mb-3">
                        <label for="id_tipo" class="form-label">Tipo de Dispositivo</label>
                        {{ formulario.tipo }}
                    </div>
                    <div class="col-12 col-md-6 mb-3">
                        <label for="id_marca" class="form-label">Marca</label>
                        {{ formulario.marca }}
                    </div>
                    <div class="col-12 col-md-6 mb-3">
                        <label for="id_modelo" class="form-label">Modelo</label>
                        {{ formulario.modelo }}
                    </div>
                    <div class="col-12 col-md-6 mb-3">
                        <label for="id_serial" class="form-label">Serial</label>
                        {{ formulario.serial }}
                    </div>
                    <div class="col-12 col-md-6 mb-3">
                        <label for="id_fecha_compra" class="form-label">Fecha de Compra</label>
                        {{ formulario.fecha_compra }}
                    </div>
                    <div class="col-12 col-md-6 mb-3">
                        <label for="id_valor_compra" class="form-label">Valor de Compra</label>
                        {{ formulario.valor_compra }}
                    </div>
                    <div class="col-12 col-md-6 mb-3">
                        <label for="id_ubicacion" class="form-label">Ubicación o Departamento</label>
                        {{ formulario.ubicacion }}
                    </div>
                    <div class="col-12 col-md-6 mb-3">
                        <label for="id_empleado_responsable" class="form-label">Empleado Responsable</label>
                        {{ formulario.empleado_responsable }}
                    </div>
                    <div class="col-12 col-md-6 mb-3">
                        <label for="id_proveedor" class="form-label">Proveedor</label>
                        {{ formulario.proveedor }}
                    </div>
                    <div class="col-12 col-md-6 mb-3">
                        <label for="id_fecha_fabricacion" class="form-label">Fecha de Fabricación</label>
                        {{ formulario.fecha_fabricacion }}
                    </div>
                    <div class="col-12 col-md-6 mb-3">
                        <label for="id_vida_util_anios" class="form-label">Vida Útil (Años)</label>
                        {{ formulario.vida_util_anios }}
                    </div>
                    <div class="col-12 col-md-6 mb-3">
                        <label for="id_nombre_red" class="form-label">Nombre de Red</label>
                        {{ formulario.nombre_red }}
                    </div>
                    <div class="col-12 col-md-6 mb-3">
                        <label for="id_fecha_recepcion" class="form-label">Fecha de Recepción</label>
                        {{ formulario.fecha_recepcion }}
                    </div>
                    <div class="col-12 col-md-6 mb-3">
                        <label for="id_fecha_mantenimiento" class="form-label">Fecha de Mantenimiento</label>
                        {{ formulario.fecha_mantenimiento }}
                    </div>
                    <div class="col-12 mb-3">
                        <label for="id_observaciones" class="form-label">Observaciones</label>
                        {{ formulario.observaciones }}
                    </div>
                    <!-- Campos específicos para laptop -->
                    <div class="col-12 col-md-6 mb-3 device-specific laptop tablet server cpu" style="display: none;">
                        <label for="id_mac_address" class="form-label">Dirección MAC</label>
                        {{ formulario.mac_address }}
                    </div>
                    <div class="col-12 col-md-6 mb-3 device-specific laptop cpu server" style="display: none;">
                        <label for="id_procesador_marca" class="form-label">Marca del Procesador</label>
                        {{ formulario.procesador_marca }}
                    </div>
                    <div class="col-12 col-md-6 mb-3 device-specific laptop cpu server" style="display: none;">
                        <label for="id_procesador_velocidad" class="form-label">Velocidad del Procesador (GHz)</label>
                        {{ formulario.procesador_velocidad }}
                    </div>
                    <div class="col-12 col-md-6 mb-3 device-specific laptop cpu server" style="display: none;">
                        <label for="id_procesador_generacion" class="form-label">Generación del Procesador</label>
                        {{ formulario.procesador_generacion }}
                    </div>
                    <div class="col-12 col-md-6 mb-3 device-specific laptop cpu server tablet" style="display: none;">
                        <label for="id_sistema_operativo" class="form-label">Sistema Operativo</label>
                        {{ formulario.sistema_operativo }}
                    </div>
                    <div class="col-12 col-md-6 mb-3 device-specific laptop server tablet" style="display: none;">
                        <label for="id_sistema_operativo_version" class="form-label">Versión del Sistema Operativo</label>
                        {{ formulario.sistema_operativo_version }}
                    </div>
                    <div class="col-12 col-md-6 mb-3 device-specific laptop server tablet" style="display: none;">
                        <label for="id_sistema_operativo_bits" class="form-label">Bits del Sistema Operativo</label>
                        {{ formulario.sistema_operativo_bits }}
                    </div>
                    <div class="col-12 col-md-6 mb-3 device-specific laptop cpu server tablet disco_duro" style="display: none;">
                        <label for="id_almacenamiento_capacidad" class="form-label">Capacidad de Almacenamiento (GB)</label>
                        {{ formulario.almacenamiento_capacidad }}
                    </div>
                    <div class="col-12 col-md-6 mb-3 device-specific laptop cpu server tablet" style="display: none;">
                        <label for="id_memoria" class="form-label">Memoria (GB)</label>
                        {{ formulario.memoria }}
                    </div>
                    <div class="col-12 col-md-6 mb-3 device-specific laptop monitor proyector tablet pantalla_proyector" style="display: none;">
                        <label for="id_size_pantalla" class="form-label">Tamaño de Pantalla (pulgadas)</label>
                        {{ formulario.size_pantalla }}
                    </div>
                    <div class="col-12 col-md-6 mb-3 device-specific laptop monitor proyector tablet" style="display: none;">
                        <label for="id_resolucion" class="form-label">Resolución</label>
                        {{ formulario.resolucion }}
                    </div>
                    <!-- Añade el resto de los campos específicos para otros tipos -->
                </div>
                <div class="text-center">
                    <button type="submit" class="btn btn-primary">Guardar</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% block JS %}
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const tipoDispositivo = document.getElementById('id_tipo');
        const deviceSpecificFields = document.querySelectorAll('.device-specific');
        const macInput = document.getElementById('id_mac_address');
        const form = document.getElementById('equipoForm');

        if (!tipoDispositivo) {
            console.error('No se encontró el elemento #id_tipo');
            return;
        }

        const deviceFields = {
            'laptop': ['mac_address', 'procesador_marca', 'procesador_velocidad', 'procesador_generacion', 'sistema_operativo', 'sistema_operativo_version', 'sistema_operativo_bits', 'almacenamiento_capacidad', 'memoria', 'size_pantalla', 'resolucion'],
            'impresora': ['impresora_tipo', 'impresora_velocidad_ppm', 'impresora_color', 'impresora_conexion'],
            'cpu': ['mac_address', 'procesador_marca', 'procesador_velocidad', 'procesador_generacion', 'memoria', 'cpu_formato_diseno'],
            'monitor': ['size_pantalla', 'resolucion'],
            'proyector': ['size_pantalla', 'resolucion', 'proyector_lumens'],
            'ups': ['ups_vatios', 'ups_fecha_bateria'],
            'scanner': ['scanner_velocidad', 'scanner_color'],
            'pantalla_proyector': ['size_pantalla', 'pantalla_proyector_tipo'],
            'tablet': ['mac_address', 'sistema_operativo', 'sistema_operativo_version', 'sistema_operativo_bits', 'almacenamiento_capacidad', 'memoria', 'size_pantalla'],
            'server': ['mac_address', 'procesador_marca', 'procesador_velocidad', 'procesador_generacion', 'sistema_operativo', 'sistema_operativo_version', 'sistema_operativo_bits', 'almacenamiento_capacidad', 'memoria', 'server_numero_procesadores'],
            'licencia_informatica': ['licencia_tipo', 'licencia_clase'],
            'mouse': ['mouse_tipo', 'mouse_conexion'],
            'disco_duro': ['almacenamiento_capacidad', 'clase_disco']
        };

        function updateFields() {
            const selectedType = tipoDispositivo.value.toLowerCase();
            console.log('Tipo seleccionado:', selectedType); // Depuración
            deviceSpecificFields.forEach(field => {
                const fieldClasses = field.classList;
                if (fieldClasses.contains(selectedType)) {
                    field.style.display = 'block';
                    const input = field.querySelector('input, select');
                    if (input && deviceFields[selectedType]?.includes(input.id.replace('id_', ''))) {
                        input.required = true;
                    }
                } else {
                    field.style.display = 'none';
                    const input = field.querySelector('input, select');
                    if (input) input.required = false;
                }
            });
        }

        updateFields();
        tipoDispositivo.addEventListener('change', updateFields);

        if (macInput) {
            macInput.addEventListener('input', function () {
                let val = macInput.value.replace(/[^a-fA-F0-9:]/g, '').toUpperCase();
                if (val.length > 17) val = val.slice(0, 17);
                macInput.value = val;
            });

            form.addEventListener('submit', function (e) {
                const mac = macInput.value.trim();
                if (mac) {
                    const macRegex = /^([0-9A-F]{2}:){5}[0-9A-F]{2}$|^[0-9A-F]{12}$/;
                    if (!macRegex.test(mac)) {
                        e.preventDefault();
                        Swal.fire({
                            icon: 'error',
                            title: 'Formato inválido',
                            text: 'La dirección MAC debe ser 12 caracteres hexadecimales (con o sin dos puntos).',
                            confirmButtonText: 'OK'
                        });
                    }
                }
            });
        }

        (function () {
            'use strict';
            var forms = document.querySelectorAll('.needs-validation');
            Array.prototype.slice.call(forms).forEach(function (form) {
                form.addEventListener('submit', function (event) {
                    if (!form.checkValidity()) {
                        event.preventDefault();
                        event.stopPropagation();
                    }
                    form.classList.add('was-validated');
                }, false);
            });
        })();
    });
</script>
{% endblock %}
{% endblock %}