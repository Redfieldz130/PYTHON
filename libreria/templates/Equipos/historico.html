{% extends "Paginas/base.html" %}

{% block titulo %}
Histórico de Equipos
{% endblock %}

{% block head %}
{% load static %}
<link rel="stylesheet" href="{% static 'css/historico.css' %}?v=11.0">
<!-- Flatpickr CSS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
{% endblock %}

{% block contenido %}
<div class="container-fluid py-4">
    <div class="header text-center py-3 shadow-sm rounded-3 bg-primary text-white">
        <h4 class="mb-0 font-weight-bold">Historial de Equipos</h4>
    </div>
   
    <div class="filter-section mt-4">
        <div class="row justify-content-center">
            <div class="col-md-4 col-sm-6 mb-3">
                <label for="fecha-eliminacion" class="form-label fw-bold">Fecha</label>
                <input type="text" id="fecha-eliminacion" class="form-control form-control-sm border-primary" placeholder="Seleccionar fecha" readonly>
                <button type="button" class="btn btn-primary btn-sm mt-2" data-bs-toggle="modal" data-bs-target="#fechaModal">Abrir Calendario</button>
            </div>
            <div class="col-md-4 col-sm-6 mb-3">
                <label for="tipo-filtro" class="form-label fw-bold">Tipo de equipo</label>
                <select id="tipo-filtro" class="form-control form-control-sm border-primary">
                    <option value="">Todos</option>
                    {% for tipo in tipos %}
                    <option value="{{ tipo.valor }}">{{ tipo.display }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-4 col-sm-6 mb-3">
                <label for="modelo-filtro" class="form-label fw-bold">Modelo</label>
                <select id="modelo-filtro" class="form-control form-control-sm border-primary">
                    <option value="">Todos</option>
                    {% for modelo in modelos %}
                    <option value="{{ modelo }}">{{ modelo }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>
    </div>

    <!-- Modal para el calendario -->
    <div class="modal fade" id="fechaModal" tabindex="-1" aria-labelledby="fechaModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="fechaModalLabel">Seleccionar Fecha</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                </div>
                <div class="modal-body text-center">
                    <input type="text" id="calendario-input" class="form-control mx-auto" style="max-width: 300px;">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                    <button type="button" class="btn btn-primary" id="aplicar-fecha">Aplicar</button>
                </div>
            </div>
        </div>
    </div>

    <div class="history-list mt-4">
        {% if historial %}
            {% for item in historial %}
            <div class="history-item shadow-sm rounded-3 mb-3 p-3 d-flex align-items-center bg-white border"
                 data-fecha="{{ item.fecha|date:'Y-m-d'|default:'' }}"
                 data-modelo="{{ item.modelo|default:'' }}"
                 data-tipo="{{ item.tipo|default:'' }}">
                <div class="item-details flex-grow-1">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="mb-1 fw-bold text-dark">{{ item.marca|default:'Sin marca' }} {{ item.modelo|default:'Sin modelo' }}</h6>
                            <p class="mb-1 text-muted small">Tipo de equipo: {{ item.tipo|default:'No especificado' }}</p>
                            <p class="mb-1 text-muted small">Serial: {{ item.serial|default:'Sin serial' }}</p>
                            <p class="mb-1 text-muted small">
                                Acción:
                                {% if item.accion == 'creado' %}Creado
                                {% elif item.accion == 'editado' %}Editado
                                {% elif item.accion == 'eliminado' %}Eliminado
                                {% elif item.accion == 'asignado' %}Asignado
                                {% elif item.accion == 'desasignado' %}Desasignado
                                {% else %}Otro{% endif %}
                            </p>
                        </div>
                        <div class="text-end">
                            <p class="mb-1 text-muted small">Fecha: {{ item.fecha|date:'Y-m-d H:i'|default:'No registrada' }}</p>
                            <p class="mb-1 text-muted small">Por: {{ item.usuario.username|default:'Usuario desconocido' }}</p>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        {% else %}
            <div class="text-center mt-4">
                <p class="text-muted">No hay equipos en el historial.</p>
            </div>
        {% endif %}
        <div class="no-results text-center mt-4" style="display: none;">
            <p class="text-muted">No se encontraron resultados para los filtros seleccionados.</p>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script>
document.addEventListener("DOMContentLoaded", function () {
    const fechaInput = document.getElementById('fecha-eliminacion');
    const calendarioInput = document.getElementById('calendario-input');
    const modeloSelect = document.getElementById('modelo-filtro');
    const tipoSelect = document.getElementById('tipo-filtro');
    const items = document.querySelectorAll('.history-item');
    const noResults = document.querySelector('.no-results');
    const aplicarFechaBtn = document.getElementById('aplicar-fecha');

    // Obtener fechas con acciones desde el contexto
    const fechasConAcciones = {{ fechas_con_acciones|safe|default:'{}' }};
    console.log('fechasConAcciones:', fechasConAcciones); // Para depuración

    // Verificar si las fechas coinciden con el formato esperado
    const verificarFechas = () => {
        for (let fecha in fechasConAcciones) {
            if (!/^\d{4}-\d{2}-\d{2}$/.test(fecha)) {
                console.error('Formato de fecha inválido:', fecha);
            }
        }
    };
    verificarFechas();

    // Construir modelosPorTipo dinámicamente desde los items del DOM
    const modelosPorTipo = {};
    items.forEach(item => {
        const tipo = item.getAttribute('data-tipo') || '';
        const modelo = item.getAttribute('data-modelo') || '';
        if (tipo && modelo) {
            if (!modelosPorTipo[tipo]) {
                modelosPorTipo[tipo] = new Set();
            }
            modelosPorTipo[tipo].add(modelo);
        }
    });

    // Convertir Sets a Arrays
    Object.keys(modelosPorTipo).forEach(tipo => {
        modelosPorTipo[tipo] = Array.from(modelosPorTipo[tipo]);
    });

    // Inicializar Flatpickr en el modal
    const flatpickrInstance = flatpickr(calendarioInput, {
        inline: true, // Mostrar calendario directamente
        dateFormat: 'Y-m-d',
        onDayCreate: function(dObj, dStr, fp, dayElem) {
            const dateStr = dayElem.dateObj.toISOString().split('T')[0]; // Formato YYYY-MM-DD
            const acciones = fechasConAcciones[dateStr];
            if (acciones && acciones.length > 0) {
                dayElem.classList.remove('has-registros', 'registro-creado', 'registro-eliminado'); // Limpiar clases previas
                if (acciones.includes("eliminado")) {
                    dayElem.classList.add("registro-eliminado");
                } else if (acciones.includes("creado")) {
                    dayElem.classList.add("registro-creado");
                } else {
                    dayElem.classList.add("has-registros");
                }
                console.log(`Fecha: ${dateStr}, Acciones: ${acciones}, Clase aplicada: ${dayElem.className}`);
            }
        },
        onChange: function(selectedDates, dateStr) {
            fechaInput.value = dateStr; // Actualizar el input principal
        }
    });

    // Aplicar fecha y cerrar modal
    aplicarFechaBtn.addEventListener('click', () => {
        applyFilter();
        const modal = bootstrap.Modal.getInstance(document.getElementById('fechaModal'));
        modal.hide();
    });

    // Al cambiar el tipo, actualizamos los modelos disponibles
    tipoSelect.addEventListener('change', () => {
        const tipoSeleccionado = tipoSelect.value;
        const modelos = modelosPorTipo[tipoSeleccionado] || [];
        modeloSelect.innerHTML = '<option value="">Todos</option>';
        modelos.forEach(modelo => {
            const option = document.createElement('option');
            option.value = modelo;
            option.textContent = modelo;
            modeloSelect.appendChild(option);
        });
        applyFilter();
    });

    // Escuchar cambios en los filtros
    modeloSelect.addEventListener('change', applyFilter);
    tipoSelect.addEventListener('change', applyFilter);

    function applyFilter() {
        const selectedFecha = fechaInput.value;
        const selectedModelo = modeloSelect.value.toLowerCase().trim();
        const selectedTipo = tipoSelect.value;
        let visibleItems = 0;

        items.forEach(item => {
            const itemFecha = item.getAttribute('data-fecha') || '';
            const itemModelo = (item.getAttribute('data-modelo') || '').toLowerCase();
            const itemTipo = item.getAttribute('data-tipo') || '';

            const matchesFecha = !selectedFecha || itemFecha === selectedFecha;
            const matchesModelo = !selectedModelo || itemModelo === selectedModelo;
            const matchesTipo = !selectedTipo || itemTipo === selectedTipo;

            const matchesAll = matchesFecha && matchesModelo && matchesTipo;

            if (matchesAll) {
                item.classList.remove('hidden');
                visibleItems++;
            } else {
                item.classList.add('hidden');
            }
        });

        noResults.style.display = visibleItems === 0 ? 'block' : 'none';
    }
});
</script>

<div style="height: 60px;"></div> <!-- Espaciador para el footer fijo -->
{% endblock %}