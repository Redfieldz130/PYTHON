{% extends "Paginas/base.html" %}

{% block titulo %}
Hist칩rico de Equipos
{% endblock %}

{% block head %}
{% load static %}
<link rel="stylesheet" href="{% static 'css/historico.css' %}?v=11.0">
<!-- Flatpickr CSS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
{% endblock %}

{% block contenido %}
<div class="container-fluid py-4">
    <div class="header text-center py-3 shadow-sm rounded-3 bg-primary text-white">
        <h4 class="mb-0 font-weight-bold">Historial de Equipos Eliminados</h4>
    </div>
   
    <div class="filter-section mt-4">
        <div class="row justify-content-center">
            <div class="col-md-4 col-sm-6 mb-3">
                <label for="fecha-eliminacion" class="form-label fw-bold">Fecha de eliminaci칩n</label>
                <input type="text" id="fecha-eliminacion" class="form-control form-control-sm border-primary" placeholder="Seleccionar fecha">
            </div>
            <div class="col-md-4 col-sm-6 mb-3">
                <label for="tipo-filtro" class="form-label fw-bold">Tipo de equipo</label>
                <select id="tipo-filtro" class="form-control form-control-sm border-primary">
                    <option value="">Todos</option>
                    {% for tipo in tipos %}
                    <option value="{{ tipo.valor }}">{{ tipo.display }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-4 col-sm-6 mb-3">
                <label for="modelo-filtro" class="form-label fw-bold">Modelo</label>
                <select id="modelo-filtro" class="form-control form-control-sm border-primary">
                    <option value="">Todos</option>
                    {% for modelo in modelos %}
                    <option value="{{ modelo }}">{{ modelo }}</option>
                    {% endfor %}
                </select>
            </div>
            
        </div>
    </div>

    <div class="history-list mt-4">
        {% if historial %}
            {% for item in historial %}
            <div class="history-item shadow-sm rounded-3 mb-3 p-3 d-flex align-items-center bg-white border"
                 data-fecha="{{ item.fecha|date:'Y-m-d'|default:'' }}"
                 data-modelo="{{ item.modelo|default:'' }}"
                 data-tipo="{{ item.tipo|default:'' }}">
                <div class="item-details flex-grow-1">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="mb-1 fw-bold text-dark">{{ item.marca|default:'Sin marca' }} {{ item.modelo|default:'Sin modelo' }}</h6>
                            <p class="mb-1 text-muted small">Tipo de equipo: {{ item.tipo|default:'No especificado' }}</p>
                            <p class="mb-1 text-muted small">Serial: {{ item.serial|default:'Sin serial' }}</p>
                            <p class="mb-1 text-muted small">
                                Acci칩n:
                                {% if item.accion == 'creado' %}Creado
                                {% elif item.accion == 'editado' %}Editado
                                {% elif item.accion == 'eliminado' %}Eliminado
                                {% elif item.accion == 'asignado' %}Asignado
                                {% elif item.accion == 'desasignado' %}Desasignado
                                {% else %}Otro{% endif %}
                            </p>
                        </div>
                        <div class="text-end">
                            <p class="mb-1 text-muted small">Fecha: {{ item.fecha|date:'Y-m-d H:i'|default:'No registrada' }}</p>
                            <p class="mb-1 text-muted small">Por: {{ item.usuario.username|default:'Usuario desconocido' }}</p>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        {% else %}
            <div class="text-center mt-4">
                <p class="text-muted">No hay equipos en el historial.</p>
            </div>
        {% endif %}
        <div class="no-results text-center mt-4" style="display: none;">
            <p class="text-muted">No se encontraron resultados para los filtros seleccionados.</p>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script>
document.addEventListener("DOMContentLoaded", function () {
    const fechaInput = document.getElementById('fecha-eliminacion');
    const modeloSelect = document.getElementById('modelo-filtro');
    const tipoSelect = document.getElementById('tipo-filtro');
    const items = document.querySelectorAll('.history-item');
    const noResults = document.querySelector('.no-results');

    const fechasConRegistros = {{ fechas_con_registros|safe|default:'[]' }};

    // Construir modelosPorTipo din치micamente desde los items del DOM
    const modelosPorTipo = {};
    items.forEach(item => {
        const tipo = item.getAttribute('data-tipo') || '';
        const modelo = item.getAttribute('data-modelo') || '';

        if (tipo && modelo) {
            if (!modelosPorTipo[tipo]) {
                modelosPorTipo[tipo] = new Set();
            }
            modelosPorTipo[tipo].add(modelo);
        }
    });

    // Convertir Sets a Arrays
    Object.keys(modelosPorTipo).forEach(tipo => {
        modelosPorTipo[tipo] = Array.from(modelosPorTipo[tipo]);
    });

    flatpickr(fechaInput, {
        dateFormat: 'Y-m-d',
        allowInput: true,
        onDayCreate: function(dObj, dStr, fp, dayElem) {
            const dateStr = dayElem.dateObj.toISOString().split('T')[0];
            if (fechasConRegistros.includes(dateStr)) {
                dayElem.classList.add('has-registros');
            }
        },
        onChange: applyFilter
    });

    function applyFilter() {
        const selectedFecha = fechaInput.value;
        const selectedModelo = modeloSelect.value.toLowerCase().trim();
        const selectedTipo = tipoSelect.value;
        let visibleItems = 0;

        items.forEach(item => {
            const itemFecha = item.getAttribute('data-fecha-eliminacion') || '';
            const itemModelo = (item.getAttribute('data-modelo') || '').toLowerCase();
            const itemTipo = item.getAttribute('data-tipo') || '';

            const matchesFecha = !selectedFecha || itemFecha === selectedFecha;
            const matchesModelo = !selectedModelo || itemModelo === selectedModelo;
            const matchesTipo = !selectedTipo || itemTipo === selectedTipo;

            const matchesAll = matchesFecha && matchesModelo && matchesTipo;

            if (matchesAll) {
                item.classList.remove('hidden');
                visibleItems++;
            } else {
                item.classList.add('hidden');
            }
        });

        noResults.style.display = visibleItems === 0 ? 'block' : 'none';
    }

    // Al cambiar el tipo, actualizamos los modelos disponibles
    tipoSelect.addEventListener('change', () => {
        const tipoSeleccionado = tipoSelect.value;
        const modelos = modelosPorTipo[tipoSeleccionado] || [];

        modeloSelect.innerHTML = '<option value="">Todos</option>';
        modelos.forEach(modelo => {
            const option = document.createElement('option');
            option.value = modelo;
            option.textContent = modelo;
            modeloSelect.appendChild(option);
        });

        applyFilter();
    });

    fechaInput.addEventListener('input', () => {
        applyFilter();
    });

    modeloSelect.addEventListener('change', () => {
        applyFilter();
    });
});
</script>

<div style="height: 60px;"></div> <!-- Espaciador para el footer fijo -->
{% endblock %}